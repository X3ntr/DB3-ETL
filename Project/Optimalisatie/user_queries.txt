select *
from treasure t
join cities c on c.city_id = t.city_city_id
where ci_name = 'Oka' AND difficulty = 2 AND (select COUNT(*)
												  from treasure_stages ts
												  where ts.treasure_id = t.id) > 2 AND terrain = 2
												  
CREATE NONCLUSTERED INDEX i_treasure_city ON treasure (difficulty, terrain) INCLUDE (city_city_id, owner_id)



select top 10 description, log_time
from treasure_log 
where treasure_id = 0x00003E2CB14041B197F00033C097E0700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
order by log_time DESC

CREATE NONCLUSTERED INDEX i_treasure_log_id ON treasure_log (treasure_id)



select *, "aantal beheerde treasures" = (select COUNT(*)
										 from treasure t
										 where t.owner_id = u.id)
from user_table u
where u.id IN (select t.owner_id
			   from treasure t
			   where t.id = 0x00003E2CB14041B197F00033C097E0700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
			   )
			   
CREATE NONCLUSTERED INDEX i_treasure_owner_id ON treasure (owner_id)



select container_size, sequence_number,type, "description" = 
											CASE 
												WHEN s.visibility = 0 THEN description
												WHEN s.visibility = 1 THEN description
												ELSE 'not available'
											END
										   , "waypoint" = 
											CASE
												WHEN s.visibility = 0 THEN LTRIM(STR(latitude, 50,20)) + ' - ' + LTRIM(STR(longitude,50,20))
												ELSE NULL
											END
from stage s
where s.id IN (select stages_id
			   from treasure_stages
			   where treasure_id = 0x00003E2CB14041B197F00033C097E0700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
			   )
order by sequence_number

CREATE NONCLUSTERED INDEX i_treasure_stages_treasure_id ON treasure_stages (treasure_id)



select top 5000 *
from treasure_log
where description like '%a%'
order by log_time

OPTIMIZE SORTING ON LOG_TIME



